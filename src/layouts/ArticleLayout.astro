---
import BaseLayout from './BaseLayout.astro';

interface Props {
  title: string;
  description?: string;
  date?: string;
  icon?: string;
  iconColor?: string;
  ogImage?: string;
}

const {
  title,
  description,
  date,
  icon = 'shield',
  iconColor = 'text-blue-500',
  ogImage,
} = Astro.props;

const siteUrl = 'https://altstore-jp.bunchoniki.com';
const canonicalUrl = new URL(Astro.url.pathname, siteUrl).toString();
---

<BaseLayout title={title} description={description} ogType="article" ogImage={ogImage}>
  <!-- Article Schema JSON-LD -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": title,
    "description": description,
    "datePublished": date,
    "dateModified": date,
    "publisher": {
      "@type": "Organization",
      "name": "bunchoniki Store",
      "url": siteUrl,
    },
    "url": canonicalUrl,
  })} />

  <main class="max-w-3xl mx-auto px-4 py-12">
    <!-- 記事一覧に戻る -->
    <div class="mb-6">
      <a href="/articles/" class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 font-bold transition-colors">
        <span class="material-symbols-outlined">arrow_back</span>
        記事一覧に戻る
      </a>
    </div>

    <article>
      <!-- ヒーロー -->
      <div class="mb-8 pb-8 border-b-2 border-blue-200">
        <h1 class="text-4xl font-bold mb-3 text-slate-800 flex items-center gap-3">
          <span class={`material-symbols-outlined ${iconColor} text-[2.5rem]`}>{icon}</span>
          {title}
        </h1>
        {description && <p class="text-gray-600 text-lg">{description}</p>}
      </div>

      <!-- MDXコンテンツ（スキャン可能UIに変換） -->
      <div class="article-content">
        <slot />
      </div>

      {date && (
        <div id="article-metadata" data-section="metadata" class="mt-8 pt-6 border-t border-gray-200">
          <p class="text-gray-500 text-sm">最終更新: {date}</p>
        </div>
      )}
    </article>
  </main>
</BaseLayout>

<script>
  // H2セクションをカード型UIに変換（スキャン可能UI）
  document.addEventListener('DOMContentLoaded', () => {
    const content = document.querySelector('.article-content');
    if (!content) return;

    const h2s = Array.from(content.querySelectorAll('h2'));
    if (h2s.length === 0) return;

    h2s.forEach((h2) => {
      // Sectionコンポーネント等でラップ済みのH2はスキップ
      if (h2.closest('.bg-white, .bg-blue-50, .bg-green-50, .bg-yellow-50')) return;

      const card = document.createElement('div');
      card.className = 'bg-white rounded-lg p-8 mb-8 border border-gray-200';

      h2.parentNode!.insertBefore(card, h2);
      card.appendChild(h2);

      // 次のH2またはコンテンツ末尾まで移動
      let next = card.nextElementSibling;
      while (next && next.tagName !== 'H2') {
        const toMove = next;
        next = next.nextElementSibling;
        card.appendChild(toMove);
      }
    });

    // カード外に残ったH2前のコンテンツをラップ
    const orphans = Array.from(content.children).filter(
      el => !el.classList.contains('bg-white')
    );
    if (orphans.length > 0) {
      const introCard = document.createElement('div');
      introCard.className = 'bg-blue-50 rounded-lg p-8 mb-8 border-l-4 border-blue-500 border border-blue-200';
      content.insertBefore(introCard, orphans[0]);
      orphans.forEach(el => introCard.appendChild(el));
    }
  });
</script>

<style>
  /* スキャン可能UIのMarkdown基本スタイル */
  .article-content h2 {
    @apply text-2xl font-bold mb-6 pb-3 border-b-2 border-gray-200 text-gray-800 flex items-center gap-2;
  }

  .article-content h3 {
    @apply text-xl font-bold mt-6 mb-3 text-gray-800;
  }

  .article-content h4 {
    @apply text-lg font-semibold mt-4 mb-2 text-gray-700;
  }

  .article-content p {
    @apply text-gray-700 leading-7 mb-4;
  }

  .article-content ul {
    @apply list-disc pl-6 space-y-2 text-gray-700 mb-6;
  }

  .article-content ol {
    @apply list-decimal pl-6 space-y-2 text-gray-700 mb-6;
  }

  .article-content li {
    @apply leading-7;
  }

  .article-content strong {
    @apply font-bold text-gray-900;
  }

  .article-content a {
    @apply text-blue-600 hover:text-blue-700 underline;
  }

  .article-content table {
    @apply w-full border-collapse mb-6 text-sm;
  }

  .article-content th {
    @apply bg-gray-100 text-gray-700 font-semibold px-4 py-2 border border-gray-200 text-left;
  }

  .article-content td {
    @apply px-4 py-2 border border-gray-200 text-gray-700;
  }

  .article-content code {
    @apply bg-gray-100 text-gray-800 px-1.5 py-0.5 rounded font-mono text-sm;
  }

  .article-content pre {
    @apply bg-gray-900 text-gray-100 p-4 rounded-lg mb-6 overflow-x-auto;
  }

  .article-content pre code {
    @apply bg-transparent text-gray-100 p-0;
  }

  .article-content blockquote {
    @apply border-l-4 border-blue-300 pl-4 text-gray-600 italic mb-4;
  }

  .article-content hr {
    @apply border-gray-200 mb-6;
  }
</style>
